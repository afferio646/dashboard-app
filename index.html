<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AfferioIQ Client Dashboard</title>
    <style>
        /* --- THEME VARIABLES (Consistent with PWA) --- */
        :root {
            --primary: #2563eb;    /* Afferio Blue */
            --primary-light: #3b82f6;
            --bg-dark: #111827;    /* Darker background for dashboard */
            --bg-card: #374151;    /* Card Background */
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --danger: #ef4444;     /* Red for critical metrics */
            --success: #10b981;    /* Green for positive metrics */
            --warning: #f59e0b;    /* Orange for attention */
            --border: #4b5563;
        }

        /* --- BASE & LAYOUT --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem 1.5rem; }

        /* --- AUTH & INPUT STYLES (Phase 2.9) --- */
        .login-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: #111827; display: flex; justify-content: center; 
            align-items: center; z-index: 1000;
        }
        .login-card {
            background: var(--bg-card); padding: 2rem; border-radius: 8px; 
            width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .input-group { margin-bottom: 1rem; text-align: left; }
        label { display: block; margin-bottom: 0.3rem; font-size: 0.9rem; color: var(--text-secondary); }
        input[type="text"], input[type="password"], textarea {
            width: 100%; padding: 0.6rem; background: #4b5563; border: 1px solid var(--border);
            border-radius: 4px; color: var(--text-primary);
        }
        .btn-primary {
            background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; 
            border-radius: 4px; cursor: pointer; width: 100%; transition: background 0.2s;
        }
        .btn-primary:hover { background: var(--primary-light); }
        
        /* --- DASHBOARD STYLES (Phase 2.1) --- */
        .header-dash { background: var(--bg-card); padding: 1.5rem; border-bottom: 1px solid var(--border); }
        .header-dash h1 { font-size: 1.5rem; color: var(--primary-light); }
        .user-info { font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .metrics-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem; margin-bottom: 2rem;
        }
        .metric-card {
            background: var(--bg-card); padding: 1.5rem; border-radius: 8px; 
            border-left: 4px solid var(--primary); box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .metric-label { color: var(--text-secondary); font-size: 0.85rem; text-transform: uppercase; margin-bottom: 0.5rem; }
        .metric-value { font-size: 2rem; font-weight: 700; }

        /* --- PUSH COMPOSER & LEAD TABLE --- */
        .main-grid { display: grid; grid-template-columns: 1fr 300px; gap: 2rem; margin-top: 2rem; }
        .sidebar-card { background: var(--bg-card); padding: 1.5rem; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; background: var(--bg-card); border-radius: 8px; overflow: hidden; }
        th, td { padding: 1rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { background: #4b5563; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; color: var(--text-secondary); }
        .status-badge { padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; }
        .status-high { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .status-low { background: rgba(16, 185, 129, 0.2); color: var(--success); }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <h2 style="color: var(--primary); margin-bottom: 1.5rem;">AfferioIQ Partner Login</h2>
            <p id="loginMessage" style="color: var(--danger); margin-bottom: 1rem;"></p>
            
            <div class="input-group">
                <label for="username">Exhibitor ID (SCHUTTE-T25 or AURA-JEWEL)</label>
                <input type="text" id="username" placeholder="Enter Exhibitor ID">
            </div>
            <div class="input-group">
                <label for="password">Password (Test: password)</label>
                <input type="password" id="password" placeholder="••••••••">
            </div>
            <button class="btn-primary" onclick="handleLogin()" style="margin-top: 1rem;">Sign In</button>
        </div>
    </div>

    <div id="dashboardContent" style="display: none;">
        <div class="header-dash">
            <div class="container">
                <h1>AfferioIQ Client Dashboard</h1>
                <p class="user-info">Logged in as: <span id="authenticatedExhName"></span> (<span id="authenticatedExhId"></span>)</p>
            </div>
        </div>

        <div class="container">
            <div class="metrics-grid">
                <div class="metric-card" id="card-distributed">
                    <div class="metric-label">Total Unique IDs Distributed</div>
                    <div class="metric-value" id="totalApps">0</div>
                    <div class="metric-caption">Goal: <span id="totalCapGoal"></span></div>
                </div>
                <div class="metric-card" style="border-left-color: var(--success);">
                    <div class="metric-label">Active Push Subscribers</div>
                    <div class="metric-value" id="subscribers">0</div>
                    <div class="metric-caption">Users retained for push communication</div>
                </div>
                <div class="metric-card" style="border-left-color: var(--danger);">
                    <div class="metric-label">AI Scans Used (Cost Meter)</div>
                    <div class="metric-value" id="scansUsed">0</div>
                    <div class="metric-caption" id="scansCaption">Target Cap: 0 scans (0% used)</div>
                </div>
                <div class="metric-card" style="border-left-color: var(--warning);">
                    <div class="metric-label">Leads Qualified (High Activity)</div>
                    <div class="metric-value" id="qualifiedLeads">0</div>
                    <div class="metric-caption">Leads with 5+ interactions or exports</div>
                </div>
            </div>

            <div class="main-grid">
                
                <div>
                    <h2>Recent App Activity</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Lead ID</th>
                                <th>Activity Type</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="activityTableBody">
                            </tbody>
                    </table>
                </div>

                <div class="sidebar-card">
                    <h2>Push Notification Composer</h2>
                    <p id="subscriberCountText" style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 1.5rem;">Target: 0 Active Subscribers</p>

                    <div class="input-group">
                        <label for="pushTitle">Notification Title</label>
                        <input type="text" id="pushTitle" placeholder="e.g., New Spindle Catalog Released!">
                    </div>

                    <div class="input-group">
                        <label for="pushBody">Message Body</label>
                        <textarea id="pushBody" placeholder="e.g., Get exclusive Q1 performance data—download the PDF today."></textarea>
                    </div>
                    
                    <div class="input-group">
                        <label for="pushURL">Target URL (Link)</label>
                        <input type="text" id="pushURL" placeholder="https://yourcompany.com/offer">
                    </div>

                    <button class="btn-primary" id="sendPushBtn" onclick="sendPushNotification()">Send Notification Now</button>
                </div>

            </div>
        </div>
    </div>

    <script>
        // =======================================================
        // === CORE DATA STRUCTURE (Phase 2.6/2.10 - Mock Database) ===
        // =======================================================
        const MOCK_MULTI_CLIENT_DATA = {
            "SCHUTTE-T25": {
                exhibitorName: "Schutte Spindle Co.",
                auth_password: "password", // Mock password
                aggregates: {
                    totalAppsDistributed: 500,
                    activeSubscribers: 385,
                    totalScansUsed: 7542,
                    scansTargetCap: 15000,
                    qualifiedLeads: 45
                },
                recentActivity: [
                    { timestamp: "2025-11-20 10:30 AM", leadId: "8F2H5K", detail: "Structural Scan Complete", status: "High Confidence" },
                    { timestamp: "2025-11-20 09:45 AM", leadId: "A1B3C4", detail: "Report Exported", status: "High Activity" },
                    { timestamp: "2025-11-20 08:15 AM", leadId: "D5E6F7", detail: "First Activation", status: "New Lead" },
                    { timestamp: "2025-11-19 04:20 PM", leadId: "J9K0L1", detail: "Push Subscribed", status: "Engaged" }
                ]
            },
            "AURA-JEWEL": {
                exhibitorName: "Aura Luxury Jewels",
                auth_password: "password", // Mock password
                aggregates: {
                    totalAppsDistributed: 1200,
                    activeSubscribers: 980,
                    totalScansUsed: 150, 
                    scansTargetCap: 5000,
                    qualifiedLeads: 180
                },
                recentActivity: [
                    { timestamp: "2025-11-20 11:00 AM", leadId: "R1S2T3", detail: "Sizing Guide Used", status: "Low Activity" },
                    { timestamp: "2025-11-20 10:15 AM", leadId: "V4W5X6", detail: "Budget Planner Export", status: "High Activity" },
                    { timestamp: "2025-11-19 03:00 PM", leadId: "Y7Z8A9", detail: "First Activation", status: "New Lead" },
                ]
            }
        };

        let authenticatedExhId = null;
        
        // =======================================================
        // === AUTHENTICATION LOGIC (Phase 2.9) ===
        // =======================================================

        // Mock Login Handler
        function handleLogin() {
            const usernameInput = document.getElementById('username').value.toUpperCase().trim();
            const passwordInput = document.getElementById('password').value.trim();
            const loginMessage = document.getElementById('loginMessage');
            
            const user = MOCK_MULTI_CLIENT_DATA[usernameInput];

            if (user && user.auth_password === passwordInput) {
                
                authenticatedExhId = usernameInput; 
                
                // Hide login screen and show dashboard
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';

                // Load the client-specific data
                loadDashboardData(authenticatedExhId);
                
            } else {
                loginMessage.textContent = 'Invalid ID or Password. Please try again.';
                document.getElementById('password').value = ''; 
            }
        }

        // =======================================================
        // === DATA LOADING & FILTERING (Phase 2.2/2.10) ===
        // =======================================================
        
        function getStatusClass(status) {
            if (status.includes("High") || status.includes("Confidence")) {
                return 'status-high';
            } else if (status.includes("New")) {
                return 'status-low';
            }
            return '';
        }

        function loadDashboardData(exhId) {
            const clientData = MOCK_MULTI_CLIENT_DATA[exhId];
            if (!clientData) {
                document.querySelector('#dashboardContent .container').innerHTML = "<h2>Error: No lead data available for this account.</h2>";
                return;
            }

            const aggregates = clientData.aggregates;

            // Update Header
            document.getElementById('authenticatedExhName').textContent = clientData.exhibitorName;
            document.getElementById('authenticatedExhId').textContent = exhId;

            // 2. Update Metrics Cards
            document.getElementById('totalApps').textContent = aggregates.totalAppsDistributed;
            document.getElementById('totalCapGoal').textContent = aggregates.totalAppsDistributed.toLocaleString();
            document.getElementById('subscribers').textContent = aggregates.activeSubscribers;
            document.getElementById('scansUsed').textContent = aggregates.totalScansUsed.toLocaleString();
            
            const percentageUsed = ((aggregates.totalScansUsed / aggregates.scansTargetCap) * 100).toFixed(1);
            const scansCaption = `Target Cap: ${aggregates.scansTargetCap.toLocaleString()} scans (${percentageUsed}% used)`;
            document.getElementById('scansCaption').textContent = scansCaption;
            
            document.getElementById('qualifiedLeads').textContent = aggregates.qualifiedLeads;
            document.getElementById('subscriberCountText').textContent = `Target: ${aggregates.activeSubscribers} Active Subscribers`;

            // 3. Update Recent Activity Table
            const tableBody = document.getElementById('activityTableBody');
            tableBody.innerHTML = ''; 

            clientData.recentActivity.forEach(activity => {
                const row = tableBody.insertRow();
                row.innerHTML = `
                    <td>${activity.timestamp}</td>
                    <td>${activity.leadId}</td>
                    <td>${activity.detail}</td>
                    <td><span class="status-badge ${getStatusClass(activity.status)}">${activity.status}</span></td>
                `;
            });
        }
        
        // =======================================================
        // === PUSH NOTIFICATION COMPOSER (Phase 3.2) ===
        // =======================================================

       // --- FINAL ENDPOINT B BLUEPRINT: Secure Push Notification Send Logic ---
async function sendPushNotification() {
    // 1. Get user input from the composer UI
    const title = document.getElementById('pushTitle').value.trim();
    const body = document.getElementById('pushBody').value.trim();
    const targetUrl = document.getElementById('pushURL').value.trim();
    
    // Safety checks
    if (!title || !body) {
        alert('Please enter a notification title and message body.');
        return;
    }
    // authenticatedExhId is available globally after successful login
    if (!authenticatedExhId) {
        alert('Authentication error: Please log in again.');
        return;
    }
    
    // *** CRITICAL: Define the BACKEND_URL here, as the dashboard is a separate component ***
    const BACKEND_URL = 'YOUR_SECURE_BACKEND_URL'; // Replace with your actual server URL

    const sendBtn = document.getElementById('sendPushBtn');
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';

    // 2. Prepare the Payload for the secure serverless function
    const pushPayload = {
        exhId: authenticatedExhId, 
        targetFilter: 'HighActivity', // Blueprint: Targeting high-value leads
        message: {
            title: title,
            body: body,
            link: targetUrl || 'https://structuralscan-app.vercel.app/'
        }
    };

    try {
        // 3. Execute Secure API Call (to Endpoint B: /api/v1/push/send)
        const response = await fetch(`${BACKEND_URL}/api/v1/push/send`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(pushPayload)
        });

        const result = await response.json();

        // 4. Handle Server Response
        if (response.ok && result.success) {
            alert(`SUCCESS! Notification sent to ${result.subscribersSent || 'ALL'} users. Check app activity log.`);
        } else {
            alert(`SEND FAILED: ${result.message || 'Server error during processing.'}`);
        }

    } catch (e) {
        console.error("Push API Failure:", e);
        alert("Network Error: Could not reach the notification server.");
    } finally {
        // 5. Reset UI
        sendBtn.disabled = false;
        sendBtn.textContent = 'Send Notification Now';
    }
}

        // =======================================================
        // --- Initialization ---
        // =======================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Optional: Auto-populate the username for quick testing
            // document.getElementById('username').value = "SCHUTTE-T25"; 
            // document.getElementById('password').value = "password";
        });
    </script>
</body>
</html>
